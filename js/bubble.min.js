class WebcamFlow{constructor(e){var t,n,a,i={width:{exact:640},height:{exact:480}},o=[],l=function(e){alert("Error: open the console"),console.log(e)},r=function(e){n=!0,t.srcObject=e,t.play(),a.startCapture(t),a.onCalculated(s)},s=function(e){o.forEach((function(t){t(e)}))};function d(e,n){var a,i,o,l,r,s=[],d=e,u=!1,c=function(){var e=function(){if(o=d.videoWidth,l=d.videoHeight-120,a.width=o,a.height=l,o&&l)return i.filter="grayscale(1) blur(4px)",i.drawImage(d,0,0,640,360,0,0,640,360),i.getImageData(0,0,o,l).data}();if(r&&e){var t,u,c,h,m,f,g,y=n,b=[],p=2*y+1;0;var v,w,C,x,E=o-y-1,D=l-y-1;for(v=y+1;v<D;v+=p)for(w=y+1;w<E;w+=p){for(t=u=c=h=m=0,C=-y;C<=y;C++)for(x=-y;x<=y;x++){var M=(v+C)*o+w+x,B=e[4*(M-1)]-e[4*(M+1)],A=e[4*(M-o)]-e[4*(M+o)],I=r[4*M]-e[4*M];t+=B*B,u+=B*A,c+=A*A,m+=B*I,h+=A*I}var L=u*u-t*c;if(0!==L){var W=y/L;f=-(h*u-m*c)*W,g=-(u*m-t*h)*W}else{var k=(u+t)*(u+t)+(c+u)*(c+u);if(0!==k){var F=-(h+m)*(y/k);f=(u+t)*F,g=(c+u)*F}else f=g=0}b.push({x:w,y:v,u:f,v:g,intensity:Math.abs(f)+Math.abs(g)})}s.forEach((function(e){e(b)}))}r=e},h=function(){u&&("requestVideoFrameCallback"in HTMLVideoElement.prototype?t.requestVideoFrameCallback(h):window.requestAnimationFrame(h),c())};if(!e){var m=new Error;throw m.message="Video tag is required",m}this.startCapture=function(){u=!0,o=d.videoWidth,l=d.videoHeight,a||((a=document.createElement("canvas")).setAttribute("id","cameraCut"),document.body.appendChild(a)),i=a.getContext("2d"),h()},this.onCalculated=function(e){s.push(e)}}this.startCapture=function(){n||(a||((t=document.createElement("video")).setAttribute("autoplay",!0),a=new d(t,e)),navigator.mediaDevices.getUserMedia({video:i}).then(r).catch(l))},this.onCalculated=function(e){o.push(e)}}}class Bubble{constructor(){let e,t=[],n=[],a=[],i=[],o=[],l=[],r=[],s=[],d=1920,u=1080,c=[],h=document.createElement("canvas");h.setAttribute("width",d+"px"),h.setAttribute("height",u+"px"),h.setAttribute("style","position: absolute; top: 0; left: 0;"),document.body.appendChild(h);let m=h.getContext("2d"),f=h.width,g=h.height,y=Date.now(),b=[];Math.ceil((u-1)/9),Math.ceil((d-1)/9);let p=[0,0,0,0,0,0,0,0],v=new WebcamFlow(4,d,u);function w(e,t){e.length=t,e.fill(0)}e=document.getElementsByClassName("bubbleControl");for(let s=0;s<e.length;s++)t.push({name:e[s].id}),c.push(e[s].offsetLeft),n[e[s].id]=[],a[e[s].id]=1,i[e[s].id]=1,b[e[s].id]=Date.now(),r[e[s].id]=1,o[e[s].id]=[],l[e[s].id]=[],w(o[e[s].id],3),w(l[e[s].id],3);let C={x1:240,x2:1680,y1:240,y2:1080};console.log(C);let x=[];v.onCalculated((function(d){console.log(d.length);for(let o=0;o<e.length;o++){let l="none"==e[o].style.display?1e4:0;t[o].x1=e[o].offsetLeft+l,t[o].x2=e[o].offsetLeft+e[o].clientWidth,t[o].y1=e[o].offsetTop+l,t[o].y2=e[o].offsetTop+e[o].clientHeight,n[e[o].id]=[],x=[],a[e[o].id]=0,i[e[o].id]=0}let u=0;for(let e=0;e<d.length;++e){let a=d[e],i=-3*a.x+1920,o=3*a.y;u+=a.intensity,i>C.x1&&i<C.x2&&o>C.y1&&o<C.y2||x.push(e);for(let a=0;a<t.length;a++)i>t[a].x1&&i<t[a].x2&&o>t[a].y1&&o<t[a].y2&&n[t[a].name].push(e)}if(0==u)return;p.push(u),p.shift(),p.reduce(((e,t)=>e+t),0)>3e4&&(y=Date.now()),m.clearRect(0,0,f,g);let c=y+6e3<Date.now()?"hidden":"visible";for(let e=0;e<t.length;e++)document.getElementById(t[e].name).style.visibility=c;if("hidden"==c)return;for(let e=0;e<d.length;++e){let o=d[e];if(o.intensity>10){for(let l=0;l<t.length;l++)n[t[l].name].includes(e)?a[t[l].name]+=10/n[t[l].name].length:x.includes(e)&&(i[t[l].name]+=o.intensity/1e3);m.strokeStyle="#000",m.lineWidth=2,m.beginPath(),m.globalAlpha=o.intensity/10,m.arc(-3*o.x+1920,3*o.y,o.intensity/2,0,2*Math.PI),m.fillStyle="#"+Math.floor(16777215*Math.random()).toString(16),m.fill()}}let h=0;for(let e=0;e<t.length;e++)o[t[e].name].push(a[t[e].name]),o[t[e].name].shift(),h+=o[t[e].name].reduce(((e,t)=>e+t),0);for(let e=0;e<t.length;e++){l[t[e].name].push(i[t[e].name]),l[t[e].name].shift(),r[t[e].name]=o[t[e].name].reduce(((e,t)=>e+t),0),s[t[e].name]=l[t[e].name].reduce(((e,t)=>e+t),0);let n=r[t[e].name]-s[t[e].name];if("Video"==t[e].name&&console.log(n,t[e].name),n>12){if(document.getElementById(t[e].name).classList.contains("bubbleContinuous")){if(b[t[e].name]+600>Date.now())return}else if(b[t[e].name]+2500>Date.now())return;b[t[e].name]=Date.now();var v=new CustomEvent(t[e].name+".Bubble",{detail:{success:1}});document.dispatchEvent(v),document.getElementById(t[e].name).style.backgroundColor="yellow",setTimeout((function(){for(let e=0;e<t.length;e++)document.getElementById(t[e].name).style.backgroundColor=""}),100),w(o[t[e].name],3),w(l[t[e].name],3)}}})),v.startCapture()}on(e,t){document.addEventListener(e+".Bubble",t,!1)}}