class WebcamFlow{constructor(e){var t,n,a,i={width:{exact:640},height:{exact:480}},o=[],l=function(e){alert("Error: open the console"),console.log(e)},r=function(e){n=!0,t.srcObject=e,t.play(),a.startCapture(t),a.onCalculated(s)},s=function(e){o.forEach((function(t){t(e)}))};function c(e,n){var a,i,o,l,r,s=[],c=e,d=!1,u=function(){var e=function(){if(o=c.videoWidth,l=c.videoHeight-120,a.width=o,a.height=l,o&&l)return i.filter="blur(8px)",i.drawImage(c,0,0,640,360,0,0,640,360),i.getImageData(0,0,o,l).data}();if(r&&e){var t,d,u,h,f,m,g,p=n,y=[],b=2*p+1;0;var v,w,C,x,E=o-p-1,M=l-p-1;for(v=p+1;v<M;v+=b)for(w=p+1;w<E;w+=b){for(t=d=u=h=f=0,C=-p;C<=p;C++)for(x=-p;x<=p;x++){var D=(v+C)*o+w+x,B=e[4*(D-1)]-e[4*(D+1)],A=e[4*(D-o)]-e[4*(D+o)],I=r[4*D]-e[4*D];t+=B*B,d+=B*A,u+=A*A,f+=B*I,h+=A*I}var W=d*d-t*u;if(0!==W){var L=p/W;m=-(h*d-f*u)*L,g=-(d*f-t*h)*L}else{var T=(d+t)*(d+t)+(u+d)*(u+d);if(0!==T){var k=-(h+f)*(p/T);m=(d+t)*k,g=(u+d)*k}else m=g=0}y.push({x:w,y:v,u:m,v:g,intensity:Math.abs(m)+Math.abs(g)})}s.forEach((function(e){e(y)}))}r=e},h=function(){d&&(t.requestVideoFrameCallback(h),u())};if(!e){var f=new Error;throw f.message="Video tag is required",f}this.startCapture=function(){d=!0,o=c.videoWidth,l=c.videoHeight,a||((a=document.createElement("canvas")).setAttribute("id","cameraCut"),document.body.appendChild(a)),i=a.getContext("2d"),h()},this.onCalculated=function(e){s.push(e)}}this.startCapture=function(){n||(a||((t=document.createElement("video")).setAttribute("autoplay",!0),a=new c(t,e)),navigator.mediaDevices.getUserMedia({video:i}).then(r).catch(l))},this.onCalculated=function(e){o.push(e)}}}class Bubble{constructor(){let e,t=[],n=[],a=[],i=[],o=[],l=[],r=[],s=[],c=1920,d=1080,u=[],h=document.createElement("canvas");h.setAttribute("width",c+"px"),h.setAttribute("height",d+"px"),h.setAttribute("style","position: absolute; top: 0; left: 0;"),document.body.appendChild(h);let f=h.getContext("2d"),m=h.width,g=h.height,p=Date.now();Math.ceil((d-1)/9),Math.ceil((c-1)/9);let y=[0,0,0,0,0,0,0,0],b=new WebcamFlow(4,c,d);function v(e,t){e.length=t,e.fill(0)}function w(){for(let e=0;e<t.length;e++)document.getElementById(t[e].name).style.background=""}e=document.getElementsByClassName("bubbleControl");for(let s=0;s<e.length;s++)e[s].innerHTML='<p class="generalElementDesc">'+e[s].innerText+"</p>",t.push({name:e[s].id}),u.push(e[s].offsetLeft),n[e[s].id]=[],a[e[s].id]=1,i[e[s].id]=1,r[e[s].id]=1,o[e[s].id]=[],l[e[s].id]=[],v(o[e[s].id],10),v(l[e[s].id],10);b.onCalculated((function(c){for(let o=0;o<e.length;o++){let l="none"==e[o].style.display?1e4:0;t[o].x1=e[o].offsetLeft+l,t[o].x2=e[o].offsetLeft+e[o].clientWidth,t[o].y1=e[o].offsetTop+l,t[o].y2=e[o].offsetTop+e[o].clientHeight,n[e[o].id]=[],a[e[o].id]=0,i[e[o].id]=0}let d=0;for(let e=0;e<c.length;++e){let a=c[e],i=-3*a.x+1920,o=3*a.y;d+=a.intensity;for(let a=0;a<t.length;a++)i>t[a].x1&&i<t[a].x2&&o>t[a].y1&&o<t[a].y2&&n[t[a].name].push(e)}y.push(d),y.shift(),y.reduce(((e,t)=>e+t),0)>8e4&&(p=Date.now()),f.clearRect(0,0,m,g);let u=p+6e3<Date.now()?"hidden":"visible";for(let e=0;e<t.length;e++)document.getElementById(t[e].name).style.visibility=u;if("hidden"==u)return;for(let e=0;e<c.length;++e){let o=c[e];if(o.intensity>7){for(let l=0;l<t.length;l++)n[t[l].name].includes(e)?a[t[l].name]+=10/n[t[l].name].length:i[t[l].name]+=o.intensity/600;f.strokeStyle="#000",f.lineWidth=2,f.beginPath(),f.globalAlpha=o.intensity/20,f.arc(-3*o.x+1920,3*o.y,Math.max(o.intensity/4,6),0,2*Math.PI),f.fillStyle="#"+Math.floor(16777215*Math.random()).toString(16),f.fill()}}let h=0;for(let e=0;e<t.length;e++)o[t[e].name].push(a[t[e].name]),o[t[e].name].shift(),h+=o[t[e].name].reduce(((e,t)=>e+t),0);for(let e=0;e<t.length;e++){if(l[t[e].name].push(i[t[e].name]),l[t[e].name].shift(),r[t[e].name]=o[t[e].name].reduce(((e,t)=>e+t),0),s[t[e].name]=l[t[e].name].reduce(((e,t)=>e+t),0),r[t[e].name]-s[t[e].name]>14){if(p+600>Date.now())return;p=Date.now();var b=new CustomEvent(t[e].name+".Bubble",{detail:{success:1}});document.dispatchEvent(b),document.getElementById(t[e].name).style.background="yellow",setTimeout((function(){w()}),100),v(o[t[e].name],10),v(l[t[e].name],10)}}})),b.startCapture()}on(e,t){document.addEventListener(e+".Bubble",t,!1)}}